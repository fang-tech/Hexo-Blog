---
tags:
  - Rapids-Qualification-Tool
  - Core
  - 事件处理模块
desc: 收集和处理Spark事件日志中的RAPIDS相关信息
---
# 事件监听器
### 基础类
事件监听器底层API

```scala
trait ToolsListenerEventExtraAPIs {

val eventTime: Long = 0 // 事件发生的时候的时间戳
val eventType: String = "" // 事件类型
}
```

事件监听器基类

```scala
trait SparkListenerEvent extends ToolsListenerEventExtraAPIs {

/* Whether output this event to the event log */

protected[spark] def logEvent: Boolean = true // 需不需要打印出来log

}
```

Spark Rapids构建信息事件

```scala
case class SparkRapidsBuildInfoEvent(

sparkRapidsBuildInfo: Map[String, String], // 构建信息

sparkRapidsJniBuildInfo: Map[String, String], // JNI构建信息

cudfBuildInfo: Map[String, String], // 

sparkRapidsPrivateBuildInfo: Map[String, String] // spark rapids私有构建信息

) extends SparkListenerEvent {

@ToolsReflection("BD-3.2.1", "Ignore")

override val eventTime: Long = 0

@ToolsReflection("BD-3.2.1", "Ignore")

override val eventType: String = ""

}
```

## Spark执行过程中各种事件的监听器
### Task开始的监听器: SparkListenerTaskStart
- stageId
- stageAttemptId
- TaskInfo
### Task结束的监听器: SparkListenerTaskEnd
- stageId: Stage的ID
- stageAttemptId: Stage重试的ID, 
	- 可以用于区分哪些执行是正常执行, 哪些执行是重试执行, 最终成功的是哪次执行
- taskType: Task的类型
- TaskEndReason: Task结束的原因
	- 成功的原因: Success
	- 失败的原因: Resubmitted, TaskKilled, ExceptionFailure, TaskCommitDenied等
- TaskInfo: 
	- taskId
	- index
	- attemptNumber
	- partitionId
	- launchTime
	- executorId
	- host
	- taskLocality
	- speculative
- taskExecutorMetrics: ExecutorMetrics
- taskMetrics: TaskMetrics Task的执行指标, 在该Stage中的所有任务的聚合指标, 也是在TaskEnd监听函数中, 所有指标的聚合信息都是从这里获取的
### Stage提交的监听器: SparkListenerStageSubmitted
- StageInfo
	- stageId
	- attemptId
	- name
	- numTasks
	- RDDInfos
	- parentIds
	- details
	- taskMetrics: 该Stage中所有的任务的聚合指标, 
		- 比如总执行器事件, 
		- 总CPU事件, 
		- 反序列化时间
		- GC时间
		- 内存溢出字节数
		- 磁盘溢出字节数
		- 输入数据指标
		- 输出数据指标
		- Shuffle读取数据
		- Shuffle写入指标
	- submissionTime
	- completionTime
	- failureReason
- Properties

### Stage完成的监听器: SparkListenerStageCompleted
- StageInfo
### SQL执行完成的监听器: SparkListenerSQLExecutionEnd
[[源码 | SparkListenerSQLExecutionEnd]]
- executionId
- time
- errorMessage
### SQL执行开始的监听器: SparkListenerSQLExecutionStart
[[源码 | SparkListenerSQLExecutionStart]]

- executionId
- rootExecutionId
# qualification: 质量分析器包 
> file: core/src/com/nvidia/spark/rapids/tool/qualification
## 入口类: QualificationMain
main -> mainInternal

- 获取进行质量评估需要的信息的pa
- 处理存储各种信息的path
## 事件处理器: QualificationEventProcessor
## 继承自EventProcessorBase
- 该事件分法器`processAnyEvent`函数通过传递进来的Event类型, 分发到不同的事件处理函数, [[源码 | processAnyEvent]]
### Task执行结束事件处理: doSparkListenerTaskEnd
- **Stage级别的Task指标聚合** (收集这个Stage上所有的Task的运行信息, 按StageId聚合信息)
	- 累加Executor上的运行时间
	- 累加Executor的CPU运行时间
	- 累加Task的运行时间 (存在序列化, 调度等额外的时间)
	- 数据读取量统计
		- 累加从数据源中读取的字节数
		- 累加从Shuffle中读取的字节数
- **SQL级别的Task指标聚合** (按SQLId聚合stage信息)
	- 累加Executor上的运行时间
	- 累加Executor的CPU运行时间
	- 累加Task的运行时间 (存在序列化, 调度等额外的时间)

### SQL事件执行结束处理: doSparkListenerSQLExecutionEnd
- (记录最后一个SQL语句执行的时间戳) 仅在非纯SQL的情景下
- 失败检查机制
	- 检查这个SQL是否有执行失败的Task
	- 将出现了失败的SQL在appInfo里面的关于执行器和CPU运行时间的统计清零
	- 